

# ESP32 Deep Learning Face Recognition mit Transparentem Display

Dieses Repository zeigt ein Beispiel für die Nutzung der ESP32 One kit ( mit der built in Kamera) in Kombination mit einem Deep Learning Modul zur Gesichtserkennung. Das erkannte Gesicht wird auf einem transparenten Display angezeigt, wobei die Position des Gesichts im Kamerastream mit einem markierten Kreis auf dem Display abgebildet wird. Für Debugging es gibt die möglichkeit din Webserver (pyserver.py) auf einem Python Server laufen zu lassen, um die Debugging Funktionalitäten zu ermöglichen.

## Voraussetzung

* [ESP-IDF](https://github.com/espressif/esp-idf/tree/v6.0-dev) - IDF Version v6.0
* [ESP-DL](https://github.com/espressif/esp-dl/tree/idfv5.3) - DL Library für Esp32, Version idfv5.3
* [U8G2] (https://github.com/olikraus/u8g2/tree/master) - Für OLED Display



* [HAL für ESP32 für Display] - Basierend auf [u8g2-hal-esp-idf](https://github.com/mkfrey/u8g2-hal-esp-idf/tree/master) von mkfrey, jedoch **modifiziert**, da das Original nicht wie erwartet funktionierte.
* [ESP32-Kamera (Version 2.1.0)](https://github.com/espressif/esp32-camera) - Kamera ist mit *idf.yy add-dependecy* eingefügt


## Installation

1. **ESP-IDF Setup**:

   * Öffne das Terminal, das während der Installation von ESP-IDF erstellt wurde.
   * Wechsel in das Hauptverzeichnis des Repositories.

2. **Zielchip festlegen**:

   ```bash
   idf.py set-target esp32
   ```

3. **Hochladen des Programmcodes**:

   ```bash
   idf.py flash
   ```

4. **Öffnen des Seriellen Monitors**:

   ```bash
   idf.py monitor
   ```

## Anwendung

Nach dem Starten des ESP32 wird das Kamerabild erfasst und auf dem Display angezeigt. Das Deep Learning-Modul führt die Gesichtserkennung durch, und auf dem transparenten Display wird ein Kreis an der Position des erkannten Gesichts angezeigt.

### Webserver für Debugging

* Der Webserver wird in **Python** ausgeführt (pyserver.py). Der Server dient zur Übertragung und Verarbeitung von Debugging-Daten.
* Die Server-URL wird im Terminal angezeigt, zum Beispiel: `http://192.168.1.177:5000/`. Diese URL muss in der Datei `app_detection.cpp` eingetragen werden, zusammen mit den Wi-Fi-Namen und -Passwortparametern.

## Fehlerbehebung

* **M5 Flash Fehler**:
  Wenn beim Flashen der ESP32 Probleme auftreten und ein **M5 Flash Error** angezeigt wird, liegt dies häufig an angeschlossenen Geräten, die Strom vom ESP32 beziehen. Um diesen Fehler zu vermeiden, trennen Sie den **3V3 Jumper** vom ESP32-Pin und verbinden ihn wieder, nachdem das Flashen abgeschlossen ist.

## Verwendete Repositories und Bibliotheken

* **Deep Learning Modul**:

  * Repository: [ESP-DL (Version idfv5.3)](https://github.com/espressif/esp-dl.git)
  * Klon-Befehl:

    ```bash
    git clone --branch idfv5.3 https://github.com/espressif/esp-dl.git
    ```

* **Kamera**:

  * Repository: [ESP32-Kamera (Version 2.1.0)](https://github.com/espressif/esp32-camera)
  * Abhängigkeit hinzufügen:

    ```bash
    idf.py add-dependency "espressif/esp32-camera@2.1.0"
    ```

* **ESP32-IDF Version**:

  * Version v6.0 (IDF v6.0)

* **Display-Bibliothek**:

  * [U8g2](https://github.com/olikraus/u8g2/tree/master)
  * Diese Bibliothek wird zur Steuerung des transparenten Displays verwendet.

* **HAL für ESP32-Display**:

  * Basierend auf [u8g2-hal-esp-idf](https://github.com/mkfrey/u8g2-hal-esp-idf/tree/master) von mkfrey, jedoch modifiziert, da das Original nicht wie erwartet funktionierte.

## Änderungen und Probleme mit der Display-HAL

Das ESP32-HAL für das Display verwendet veraltete I2C-Treiber, die mit den I2C-Treibern für die Kamera und den Sensoren von ESP32 in Konflikt geraten. Daher wurde die Datei `u8g2_esp32_hal.c` geändert, um den I2C-Treiber nicht zu initialisieren, da SPI für das Display verwendet wird.

## Konfiguration

Änderungen an der Konfiguration des ESP32 können in der Datei `sdkconfig.default` vorgenommen werden (entspricht der Konfiguration in `idf.py menuconfig`). Wenn Änderungen vorgenommen werden, muss die Datei `sdkconfig` gelöscht und das Programm erneut gebaut werden, damit die neue Konfiguration übernommen wird.

### Konfigurationsparameter

Alle ESP32-Konfigurationsparameter sind in der Datei `sdkconfig.default` aufgelistet.

## Debugging

Um die Kamera und das Deep Learning-Modul zu debuggen, müssen die Funktionen `test_detection()` in `main.cpp` und `pyserver.py` aufgerufen werden. Der Server läuft in Python und verarbeitet die Daten, die die Kamera und das Deep Learning-Modul erfassen, da der ESP32 nicht genügend Speicher für alle Prozesse hat.

Der Server läuft auf der URL, die im Terminal angezeigt wird, und muss in der Datei `app_detection.cpp` eingetragen werden, um mit dem ESP32 zu kommunizieren. Ein Beispiel für die URL könnte `http://192.168.1.177:5000/` sein.

---

### Hinweise

* Wenn Du Probleme mit der Speichergröße beim Flashen hast, prüfe die Partitionstabelle und stelle sicher, dass der verwendete Flash-Speicher groß genug ist (mindestens 8 MB empfohlen).
